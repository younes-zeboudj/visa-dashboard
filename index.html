<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
            crossorigin="anonymous"
    />

    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
            crossorigin="anonymous"
    ></script>

    <link
            href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/css/bootstrap-editable.css"
            rel="stylesheet"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/js/bootstrap-editable.min.js"></script>

    <script type="module" src="js/clipboard.js"></script>
    <script type="module" src="js/dashboard_functions.js"></script>
</head>
<style>
    #tabs button:disabled {
        border: 3px solid rgba(255, 255, 255, 0.4);
    }

    .command {
        text-align: start;
        display: flex;
        margin: 10px;
        align-items: center;
    }

    .command button, .command input, .command select {
        margin: 5px;
    }
</style>
<body>
<div
        style="
        padding: 10px;
        background-color: antiquewhite;
        border-bottom: 1px solid goldenrod;
        margin-bottom: 10px;
        text-align: center;
      "
>
    <div
            style="width: 100%; text-align: center; align-items: center; gap: 3px"
            class="row"
    >
        <label onclick="(()=>{
            if(window.last_click===undefined) return window.last_click= Date.now()
            if(Date.now()-window.last_click<500) {
                document.querySelector('[name=app_url]').value= 'http://localhost:8889';
                window.appurl= 'http://localhost:8889'
                if(!getCookie('appurl')) setCookie('appurl', 'http://localhost:8889')
                $('#tabs button:disabled').click()
                refreshState(); return
            }
            window.last_click= Date.now()
        })()" style="width: 17%; display: inline-block">App URL:</label>
        <input
                onkeyup="document.querySelector('#appurl_btnset').disabled= undefined"
                style="width: 65%; display: inline-block"
                name="app_url"
                placeholder="app url"
        />
        <button
                id="appurl_btnset"
                onclick="(()=>{
        console.log('btn clicked')
window.appurl= document.querySelector('[name=app_url]').value
if(window.appurl && window.appurl.endsWith('/'))window.appurl= window.appurl.substring(0, window.appurl.length-1);
setCookie('appurl', window.appurl)
this.disabled= true
refreshState()
      })()"
                style="width: 10%; display: inline-block"
                class="btn btn-sm btn-primary"
                disabled
        >
            Set
        </button>
        <button
                style="width: 10%; display: inline-bloc; width: 5%"
                class="btn btn-sm btn-primary"
                onclick="
      if(this.innerText=='^')
        document.querySelector('#controlpan').style.display='none';
        else
        document.querySelector('#controlpan').style.display='flex';

        this.innerText=this.innerText=='^'?'o':'^'
      "
        >
            ^
        </button>
    </div>
    <div
            id="controlpan"
            style="
          border: 2px black stripped;
          margin: 1%;
          align-items: flex-start;
          justify-content: space-around;
          display: flex;
        "
    >
        <div style="
          width: 40%;
          display: inline-block;
          ">
            <div
                    style="

          padding: 30px;
          border: 2px dashed;
          border-radius: 10px;
          "
            >
          <span>
            <span>Is running:</span>

            <span id="status"
            ><button
                    style="width: 25px; height: 25px; border-radius: 30px"
                    class="btn btn-secondary"
            ></button
            ><span> unknown</span></span
            >
          </span>
                <br/>
                <span>
            <span>System memory:</span>

            <span id="memoryStatus"><span> unknown</span></span>
          </span>
                <br/>
                <!-- <span>
                  <span>Captcha server memory:</span>

                  <span id="captchaServerMemoryStatus"><span> unknown</span></span>
                </span> -->
            </div>

            <div
                    style="
  margin-top: 15px;
          padding-top: 30px;
          padding-bottom: 30px;
          border: 2px dashed;
          border-radius: 10px;
          "
            >
                <button
                        style="margin-bottom: 15px"
                        id="run_cloud_btn"
                        class="btn btn-success btn-sm"
                        onclick="(()=>{
                        const isDupBdl= document.querySelector('#cloud_dup_bdl').checked
                        const isBdlOnly= document.querySelector('#cloud_bdl_only').checked
                        const clients= document.querySelector('#run_cloud_clients').value
                        const applicants= document.querySelector('#run_cloud_applicants').value

                        const cmd= `node folder.run.js - ${isDupBdl?'bdl':''} ${isBdlOnly?'bdlo':''} ${clients?'clients='+clients:''} ${applicants?'names='+applicants:''}`
                        exec_command(cmd)
                        })()"
                >
                    run multi
                </button>
                <button
                        style="margin-bottom: 15px"
                        id="run_cloud_btn"
                        class="btn btn-success btn-sm"
                        onclick="(async ()=>{
                            let folders= await new Promise(resolve=>$.get(`${window.appurl}/exec_sync?cmd=ls -d */`, data=>resolve(data)))
                            folders= folders.split('\n').filter(folder=>folder.trim())
                            const execCmd= (folder)=> `exec_command(\`node folder.run.js ${folder}\`); document.querySelector(\`#popup_ui_background\`).click()`
                            const buttonsHtml= folders.map(folder=>`<button class='btn btn-lg btn-light m-5' onclick='${execCmd(folder)}'>${folder}</button>`).join('')
                            show_titled_ui($(`<div style='display: flex; flex-wrap: wrap; justify-content: space-around'>${buttonsHtml}</div>`)[0], 'Select folder')
                        })()"
                >
                    run folder
                </button>

                <br/>
                <div
                        class="form-check"
                        style="display: inline-block; border: 0.1px dashed black"
                >
                    <input
                            id="cloud_dup_bdl"
                            name="cloud_dup_bdl"
                            class="form-check-input"
                            type="checkbox"
                            style="width: 20px; display: inline-block"
                    /><label class="form-check-label" for="cloud_dup_bdl">
                    DUP BDL
                </label>
                </div>
                <div
                        class="form-check"
                        style="display: inline-block; border: 0.1px dashed black"
                >
                    <input
                            id="cloud_bdl_only"
                            name="cloud_bdl_only"
                            class="form-check-input"
                            type="checkbox"
                            style="width: 20px; display: inline-block"
                    /><label class="form-check-label" for="cloud_bdl_only">
                    BDL ONLY
                </label>
                </div>
                <br/>
                <label style="display: inline-block">clients:</label>
                <input
                        value=""
                        name="run_cloud_clients"
                        id="run_cloud_clients"
                        placeholder="c1,c2,..."
                        class="form-control-sm form-control"
                        style="width: 150px; display: inline-block"
                />
                <br/>
                <label style="display: inline-block">applicants:</label>
                <input
                        value=""
                        name="run_cloud_applicants"
                        id="run_cloud_applicants"
                        placeholder="a1,a2,..."
                        class="form-control-sm form-control"
                        style="width: 150px; display: inline-block"
                />
                <br/>

            </div>

            <div
                    style="
            margin-top: 15px;
            padding-top: 30px;
            padding-bottom: 30px;
            border: 2px dashed;
            border-radius: 10px;
            ">
                <button class="btn btn-success" style="accent-color: #1abc9c" onclick="showAddPasspPage()">add new
                    process
                </button>

                <button class="btn btn-success" style="accent-color: #1abc9c" onclick="window.show_bdl_success_table()">
                    bdl reservations
                </button>

                <button class="btn btn-success" style="accent-color: #1abc9c" onclick="window.show_db_table()">
                    database
                </button>
            </div>
        </div>

        <div
                style="
            width: 50%;
            padding: 30px;
            display: inline-block;
            border: 2px dashed;
            border-radius: 10px;
          "
        >
            <style>
                button {
                    margin-top: 3px;
                }
            </style>
            <button
                    id="run_btn"
                    class="btn btn-success btn-sm"
                    onclick="startapp()"
            >
                run
            </button>
            <button
                    id="run_btn_gui"
                    class="btn btn-success btn-sm cmd"
                    command="nohup node main.js"
                    onclick="exec_command(this.getAttribute('command'))"
            >
                run gui
            </button>
            <button
                    id="run_btn_gui_win"
                    class="btn btn-success btn-sm cmd"
                    command="node main.js"
                    onclick="exec_command(this.getAttribute('command'))"
            >
                run gui win
            </button>
            <button
                    id="stop_btn"
                    class="btn btn-danger btn-sm"
                    onclick="stopapp()"
            >
                stop
            </button>
            <button class="btn btn-primary btn-sm" onclick="refreshState()">
                refresh
            </button>
            <input
                    onchange="(()=>{
              const cmds= document.querySelectorAll('.cmd')
for (const cmd of cmds) {
  if(this.checked)
  cmd.setAttribute('command', cmd.getAttribute('command')+' debug')
 else
cmd.setAttribute('command', cmd.getAttribute('command').replace(' debug', ''))

            }
          })()"
                    name="debug"
                    class="form-check-input"
                    type="checkbox"
                    style="width: 20px; display: inline-block"
            /><label class="form-check-label" for="defaultCheck1"> debug </label>
            <button
                    class="btn btn-primary btn-sm"
                    onclick="exec_command('git stash; git pull')"
            >
                update
            </button>

            <br/>
            <button
                    id="restart_proxy"
                    style="
              padding: 0.3em 0.6em;
              box-shadow: 0 2px 1px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.4) inset;
              background-color: #333;
              color: #fff;
              border: 1px solid #000;
              border-radius: 3px;
              text-decoration: none;
              cursor: pointer;
              font-size: 7pt;
            "
                    onclick="restartproxy()"
            >
                restart proxy
            </button>

            <button
                    id="up_acc_serv"
                    style="
              padding: 0.3em 0.6em;
              box-shadow: 0 2px 1px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.4) inset;
              background-color: #333;
              color: #fff;
              border: 1px solid #000;
              border-radius: 3px;
              text-decoration: none;
              cursor: pointer;
              font-size: 7pt;
            "
                    onclick="updateAccServer()"
            >
                up. accounts server
            </button><br/>
            <button
                    style="
              padding: 0.3em 0.6em;
              box-shadow: 0 2px 1px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.4) inset;
              background-color: #a59696;
              color: #fff;
              border: 1px solid #000;
              border-radius: 3px;
              text-decoration: none;
              cursor: pointer;
              font-size: 9pt;
            "
            >
                <a
                        style="text-decoration: none; color: #000"
                        target="_blank"
                        href="http://152.70.179.226:2223/accounts_edit"
                >Edit accounts</a
                >
            </button>

            <button
                    onclick="update_ui()"
                    style="
              padding: 0.3em 0.6em;
              box-shadow: 0 2px 1px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.4) inset;
              background-color: #a59696;
              color: #fff;
              border: 1px solid #000;
              border-radius: 3px;
              text-decoration: none;
              cursor: pointer;
              font-size: 9pt;
            "
            >
                Update
            </button>

            <hr/>
            <div    style="display: flex; align-items: center; justify-content: center; gap: 10px">
                <div style="display: inline-block; border: 1px solid grey; border-radius: 5px; padding: 5px">
                    <div style="display: inline-block; border: 1px solid grey; border-radius: 5px;">
                        <div class="command">
                            <label>wilaya
                            </label>

                            <select name="wilaya" class="form-select-sm">
                                <option selected value="alg" selected>alger</option>
                                <option value="oran">oran</option>
                                <option value="adrar">adrar</option>
                                <option value="annaba">annaba</option>
                                <option value="ghard">ghardaia</option>
                                <option value="const">constantine</option>
                                <option value="tindouf">tindouf</option>
                            </select>
                        </div>
                    </div>

                    <div class="command">
                        <button
                                onclick="start_random(this)"
                                id=""
                                class="mb-1 btn btn-primary btn-sm"
                        >
                            start random
                        </button>
                        <input
                                value="1"
                                name="n"
                                placeholder="Num"
                                class="form-control-sm form-control"
                                style="width: 50px; display: inline-block"
                        />

                        <div
                                class="form-check"
                                style="display: flex; align-items: center; border: 0.1px dashed black"
                        >
                            <input
                                    checked
                                    name="cib"
                                    id="isRunCIB"
                                    class="form-check-input"
                                    type="checkbox"
                                    style="width: 20px; display: inline-block"
                            /><label class="form-check-label" for="isRunCIB">
                            CIB
                        </label>
                            <input
                                    value=""
                                    name="randpaspn"
                                    placeholder="Pasps?"
                                    class="form-control-sm form-control"
                                    style="width: 50px; display: inline-block"
                            />
                        </div>

                        <select name="type" class="form-select-sm visatypes">
                            <option value="782" selected>782</option>
                            <option value="874">874</option>
                            <option value="1005" selected>1005</option>
                            <option value="1012" selected>1012</option>
                            <option value="1004">1004</option>
                            <option value="907">907</option>
                            <option value="5839">Italy - 5839</option>
                        </select>
                    </div>

                    <div class="command">
                        <button
                                id="startwatchertn"
                                class="mb-1 btn btn-primary btn-sm"
                                onclick="startwatcher(this)"
                        >
                            start watcher
                        </button>
                        <input
                                value="1"
                                name="nw"
                                placeholder="Num"
                                class="form-control-sm form-control"
                                style="width: 50px; display: inline-block"
                        />

                        <div style="display: inline-block; border: 0.1px dashed black">
                            <div class="form-check">

                                <input class="form-check-input" type="radio" name="watcherType" id="iswatcherdb"
                                       value="iswatcherdb">
                                <label class="form-check-label" for="iswatcherdb">
                                    DB
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="watcherType" id="iswatcherapplist"
                                       value="iswatcherapplist"
                                       checked>
                                <label class="form-check-label" for="iswatcherapplist">
                                    OTPE
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="watcherType" id="iswatchervac"
                                       value="iswatchervac" checked>
                                <label class="form-check-label" for="iswatchervac">
                                    VAC
                                </label>
                            </div>
                        </div>

                        <select name="watchertype" class="form-select-sm visatypes">
                            <option value="782" selected>782</option>
                            <option value="874">874</option>
                            <option value="1005" selected>1005</option>
                            <option value="1012" selected>1012</option>
                            <option value="1004">1004</option>
                            <option value="907">907</option>
                            <option value="5839">Italy - 5839</option>
                        </select>
                    </div>

                </div>

                <div style="display: inline-block; border: 1px solid grey; border-radius: 5px; padding: 5px">

                    <div class="command">
                        <button
                                id="newAccBtn"
                                class="mb-1 btn btn-primary btn-sm"
                                onclick="(()=>{
                const phone= $('[name=newacc_phone]').val()
                let bootstrap= ''
                if(phone) bootstrap=`Mobile=${phone}`
                exec_command('node src/wrappers/new.accounts.js '+$('[name=newacc_n]').val()+ ' '+bootstrap+' -c '+$('[name=newacccountry]').val())
              })()"
                        >
                            new accounts
                        </button>
                        <input
                                value="1"
                                name="newacc_n"
                                placeholder="Num"
                                class="form-control-sm form-control"
                                style="width: 30px; display: inline-block"
                        />
                        <input
                                value=""
                                name="newacc_phone"
                                placeholder="phone?"
                                class="form-control-sm form-control"
                                style="width: 140px; display: inline-block"
                        />
                        <select name="newacccountry" class="form-select-sm">
                            <option value="fr" selected>fr</option>
                            <option value="it">it</option>
                            <option value="gr">gr</option>
                            <option value="fl">fl</option>
                            <option value="nl">nl</option>
                            <option value="mt">mt</option>
                            <option value="mopt">mopt</option>

                        </select>
                    </div>
                </div>
            </div>
            <script>
                function showAddPasspPage() {
                    const div = document.createElement('div')
                    div.setAttribute('style', 'margin: 10%; position:absolute; top:0; left:0; width:80%; height:80%; background-color:rgba(200,200,200,1); z-index:10000')

                    const iframe = $(`<iframe frameborder="0" scrolling="no"  onload="resizeIframe(this)" style="border: 3px #0A9B6A solid; position: absolute; border-radius: 10px; transform:translate(10%, 10%); width:80%;" src="/add.html?embedded=true${window.appurl ? '&appurl=' + window.appurl : ''}" ></iframe>`)[0]
                    // no click propagation
                    iframe.onclick = (e) => {
                        e.stopPropagation()
                    }
                    // div.innerHTML= iframe

                    const background = document.createElement('div')
                    background.setAttribute('style', 'position:absolute; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000')

                    document.body.appendChild(background)
                    background.appendChild(iframe)
                    background.onclick = () => {
                        document.body.removeChild(background)
                    }
                    //prevent document scroll

                    //hide on escape
                    iframe.onkeydown = (e) => {
                        if (e.key === 'Escape') {
                            document.body.removeChild(background)
                        }
                    }
                    document.onkeydown = (e) => {
                        if (e.key === 'Escape') {
                            document.body.removeChild(background)
                        }
                    }
                }
            </script>
            <hr/>
            <span
                    id="server_resp"
                    style="
              font-size: 9pt;
              font-family: Verdana, Geneva, Tahoma, sans-serif;
              font-weight: 400;
            "
            ></span>
        </div>
    </div>
</div>
<div
        id="tabs"
        style="
        padding: 10px;
        background-color: cadetblue;
        border-top: 1px solid darkslategrey;
        margin-bottom: 10px;
        text-align: center;
      "
>

    <button url="/cards.html" class="btn btn-light appurl_missing">
        Payment cards
    </button>
<!--    <button url="/otps.html" class="btn btn-danger appurl_missing">-->
<!--        OTPs-->
<!--    </button>-->
    <button url="/clients.html" class="btn btn-light appurl_missing">
        Clients
    </button>
    <button url="/reservations.html" class="btn btn-light appurl_missing">
        Reservations
    </button>
    <button
            id="activetab"
            url="/running.html"
            class="btn btn-light appurl_missing"
    >
        Processes
    </button>
    <button url="/log.html" class="btn btn-light appurl_missing">Log</button>
    <button url="/edit_json.html" class="btn btn-light appurl_missing">
        Edit config
    </button>

    <button url="/edit_file.html" class="btn btn-light appurl_missing">
        Edit proxies
    </button>
</div>
<iframe width="100%" style="height: 100%; position: absolute"></iframe>
</body>
<script>
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(";");
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == " ") c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function eraseCookie(name) {
        document.cookie =
            name + "=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
    }

    window.appurl = getCookie("appurl") || "";
    if (window.appurl.endsWith("/"))
        window.appurl = window.appurl.substring(0, window.appurl.length - 1);

    console.log(`app url is ${window.appurl}`);
    document.querySelector("[name=app_url]").value = window.appurl;

    //update buttons
    let currentUrl = document.location.href;
    if (currentUrl.endsWith(".html"))
        currentUrl = currentUrl.replace(/\/\w+\.html/, "");
    else if (currentUrl.endsWith("/"))
        currentUrl = currentUrl.replace(/\/$/, "");

    document.querySelectorAll(".appurl_missing").forEach((e) => {
        e.onclick = (evt) =>
            update_frame(
                `${currentUrl}${e.getAttribute("url")}?appurl=${window.appurl || ""}`
            );
    });

    function update_frame(url) {
        document.querySelector("iframe").id = Date.now();
        document.querySelector("iframe").src = url;
    }

    document.querySelectorAll("#tabs button").forEach((e) => {
        e.addEventListener("click", (evt) => {
            e.parentElement
                .querySelectorAll("button")
                .forEach((e) => (e.disabled = false));
            e.disabled = true;
        });
    });
    $("#activetab").click();

    //CANCELLATION ROUTINE

    async function startapp() {
        const resp = await new Promise((resolve, reject) => {
            $.ajax(`${window.appurl}/launch`, {
                success: (data, textstatus, xhr) => {
                    console.log(`received resp ${data}`);
                    resolve(data);
                },
                error: (xhr, textstatus, error) => {
                    reject(error);
                },
            });
        });

        console.log(`server returned ${resp}`);
        document.querySelector(
            "#server_resp"
        ).innerHTML = `<b>response></b> ${resp}`;

        clearLog();
        setTimeout(refreshState, 1500);
    }

    function clearLog() {
        setTimeout(
            () => (document.querySelector("#server_resp").innerText = ""),
            3000
        );
    }

    async function stopapp() {
        const resp = await new Promise((resolve, reject) => {
            $.ajax(`${window.appurl}/stop`, {
                success: (data, textstatus, xhr) => {
                    console.log(`received resp ${data}`);
                    resolve(data);
                },
                error: (xhr, textstatus, error) => {
                    reject(error);
                },
            });
        });

        document.querySelector(
            "#server_resp"
        ).innerHTML = `<b>response></b> ${resp}`;

        clearLog();
        refreshState();
    }

    async function refreshState() {
        if (!window.appurl) return;
        const stat = await new Promise((resolve, reject) => {
            $.ajax(`${window.appurl}/stat?memory=1&isup=1&captcha_server=1`, {
                success: (data, textstatus, xhr) => {
                    console.log(`received resp ${data}`);
                    resolve(data);
                },
                error: (xhr, textstatus, error) => {
                    reject(error);
                },
            });
        }).catch((e) => "unknown");

        const isup = stat.isup;

        document
            .querySelector("#status button")
            .classList.remove("btn-secondary", "btn-success", "btn-danger");
        document
            .querySelector("#status button")
            .classList.add(
            isup == "ok"
                ? "btn-success"
                : isup == "not ok"
                    ? "btn-danger"
                    : "btn-secondary"
        );
        document.querySelector("#status span").innerText =
            " " +
            (isup == "ok" ? "running" : isup == "not ok" ? "stopped" : "unknown");
        document.querySelector("#run_btn").disabled = isup == "ok" ? true : false;
        document.querySelector("#run_btn_gui").disabled =
            isup == "ok" ? true : false;
        document.querySelector("#run_btn_gui_win").disabled =
            isup == "ok" ? true : false;
        document.querySelector("#stop_btn").disabled =
            isup == "not ok" ? true : false;

        document.querySelector("#memoryStatus span").innerText = stat.memory;
        // document.querySelector("#captchaServerMemoryStatus span").innerText =
        //   stat.captcha_server_memory + ` (${stat.captcha_server_pid})`;
        window.processes = stat.processes;
    }

    refreshState()
        .catch((e) => console.log(e))
        .finally(() => {
            setInterval(() => {
                refreshState();
            }, 3000);
        });

    async function restartproxy() {
        const resp = await new Promise((resolve, reject) => {
            $.ajax(`${window.appurl}/restart`, {
                success: (data, textstatus, xhr) => {
                    console.log(`received resp ${data}`);
                    resolve(data);
                },
                error: (xhr, textstatus, error) => {
                    reject(error);
                },
            });
        });

        console.log(`server returned ${resp}`);
        document.querySelector(
            "#server_resp"
        ).innerHTML = `<b>response></b> ${resp}`;

        clearLog();
        setTimeout(refreshState, 1000);
    }


    const inverse_country_visacats_map = {
        5839: 'it',
        5247: 'it',
        4632: 'it',
        4633: 'it',
        5838: 'it',
        5508: 'it',
    }

    function start_random(btn) {
        const parent = btn.closest(".command");
        const howmany = parseInt(parent.querySelector("[name=n]").value);
        const iscib = parent.querySelector("[name=cib]").checked;
        const type = parent.querySelector("[name=type]").value;
        const paspsn = parent.querySelector("[name=randpaspn]").value
        const visatype= type.split('/')[1];
        const country = type.split('/')[0];

        exec_command(
            `node random.booking.js ${howmany} ${visatype} ${iscib ? "cib" : ""} -c ${country} -w ${document.querySelector("[name=wilaya]").value} ${paspsn ? '-a ' + paspsn : ""}`
        );
    }

    function startwatcher(btn) {
        const parent = btn.closest(".command");
        const howmany = parseInt(parent.querySelector("[name=nw]").value);
        const watcherType = parent.querySelector("[name=watcherType]:checked").value;
        const type = parent.querySelector("[name=watchertype]").value;
        const visaType = type.split('/')[1];
        const country = type.split('/')[0];

        let i = parseInt(howmany);
        while (i-- > 0)
            exec_command(`node watch.js ${visaType} ${watcherType == 'iswatcherdb' ? "-wd 1" : ""}  ${watcherType == 'iswatcherapplist' ? "-wa 1" : ""} -c ${country} -w ${document.querySelector("[name=wilaya]").value}`);
    }

    async function exec_command(cmd) {
        const resp = await new Promise((resolve, reject) => {
            $.ajax(
                `${window.appurl}${
                    window.appurl.endsWith("/") ? "" : "/"
                }exec?cmd=${cmd}`,
                {
                    success: (data, textstatus, xhr) => {
                        console.log(`received resp ${data}`);
                        resolve(data);
                    },
                    error: (xhr, textstatus, error) => {
                        reject(error);
                    },
                }
            );
        });

        console.log(`server returned ${resp}`);
        document.querySelector(
            "#server_resp"
        ).innerHTML = `<b>response></b> ${resp}`;

        clearLog();
        setTimeout(refreshState, 1000);
        return resp
    }

    function update_ui(notClicked) {
        $.get(`http://152.70.179.226:2287/exec?cmd=${encodeURIComponent('cd ~/visa-dashboard; git fetch; git status')}`, (data) => {
            if (data.includes('branch is behind')) {
                document.body.innerHTML = `<h1 style='text-align:center'>Updating...</h1>`
                $.get(`http://152.70.179.226:2287/exec?cmd=${encodeURIComponent('cd ~/visa-dashboard; git add -A .; git stash; git pull')}`, (data) => {
                    window.location.reload()
                })
            } else {
                if (!notClicked) alert('already up to date!')
            }
        })
    }


    function updateAccServer() {
        $.get(`http://152.70.179.226:2287/exec?cmd=${encodeURIComponent('cd ~/visa-dashboard; git stash; git pull; rm ~/server/accounts.server.js ; cp accounts.server.js ~/server/; touch ~/server/kills')}`, (data) => {
            console.log(`server updated`)
        })
    }

    update_ui(true);

    function resizeIframe(obj) {
        obj.style.height = obj.contentWindow.document.documentElement.scrollHeight + 'px';
    }


    const visacats = {
        fr: [
            {name: "tourism", value: 782},
            {name: "student", value: 781},
            {name: "renouv", value: 874},
            {name: "ofii", value: 1005},
            {name: "medical", value: 907},
            {name: "typenew", value: 1012},
            {name: "kafala", value: 1004},
        ],
        it: [
            {name: "business vac", value: 5247},
            {name: "business cib", value: 5839},
            {name: "national d (vac)", value: 4632},
            {name: "other (vac)", value: 4633},
            {name: "student (cib)", value: 5838},
            {name: "tourism (cib)", value: 5508},
        ],
        gr: [
            {name: "tourism", value: 4633},
            {name: "familly", value: 4632},
            {name: "business", value: 4631},
        ],
        nl: [
            {name: "business", value: 4036},
            {name: "short", value: 2779},
        ],
        as: [
            {name: "business", value: 5148},
            {name: "renew", value: 5641},
            {name: "short", value: 5090},
            {name: "tourism", value: 1289},
        ],
        mt: [{name: "short", value: 3027}],
    };

    document.querySelectorAll('.visatypes').forEach(e=>{
        e.innerHTML=''

        let html = ''
        for (const [key, value] of Object.entries(visacats)) {
            html += `<optgroup label="${key}">`
            value.forEach(v=>{
                html += `<option value="${key}/${v.value}">${v.name}</option>`
            })
            html += `</optgroup>`
        }
        e.innerHTML=html
    })
</script>
</html>
